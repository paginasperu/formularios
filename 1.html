<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Licorería Express - Catálogo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --main-color: #7c3aed; } /* Color dinámico */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .modal-active { overflow: hidden; }
        .category-pill.active { background-color: var(--main-color); color: white; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

    <script>
        const CONFIG = {
            sheetUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRUcc0qpHG3yPnGv714JJlzLkry_VWsKvIdrPCS-2fIM5oSLPL0a_MmyzUk9eQomrBkplUL5auyxhmV/pub?gid=0&single=true&output=csv',
            businessName: 'Licorería Premium',
            mainColor: '#b91c1c', // Rojo licorería
            currency: 'S/ ',
            whatsapp: '51900000000',
            instagram: '#',
            facebook: '#',
            tiktok: '#',
            cacheTime: 3600000, // 1 hora
            prefix: 'lic_store_'
        };
        document.documentElement.style.setProperty('--main-color', CONFIG.mainColor);
    </script>

    <header class="sticky top-0 z-40 bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-2 flex items-center justify-between gap-4">
            <h1 class="font-bold text-xl flex-shrink-0" id="brand-logo">Cargando...</h1>
            
            <div class="relative flex-grow max-w-md">
                <input type="text" id="search-input" placeholder="Buscar..." class="w-full pl-10 pr-4 py-2 border rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-[var(--main-color)]">
                <i class="fa fa-search absolute left-4 top-3 text-gray-400"></i>
            </div>

            <button onclick="toggleCart()" class="relative p-2">
                <i class="fa fa-shopping-cart text-2xl"></i>
                <span id="cart-count" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
            </button>
        </div>
        
        <div id="category-bar" class="flex gap-2 overflow-x-auto px-4 py-2 no-scrollbar bg-gray-100 border-t border-b whitespace-nowrap">
            <button onclick="filterCategory('all')" class="category-pill active px-4 py-1 rounded-full text-sm border bg-white">Todas</button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 min-h-screen">
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            <div class="skeleton h-64 rounded-lg"></div>
            <div class="skeleton h-64 rounded-lg"></div>
            <div class="skeleton h-64 rounded-lg"></div>
            <div class="skeleton h-64 rounded-lg"></div>
        </div>
        
        <div id="pagination" class="mt-10 flex justify-center gap-2"></div>
    </main>

    <div id="product-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto relative p-6">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-2xl">&times;</button>
            <div id="modal-content"></div>
        </div>
    </div>

    <div id="cart-sidebar" class="fixed inset-y-0 right-0 z-50 w-full sm:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300">
        <div class="flex flex-col h-full">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-lg font-bold">Tu Pedido</h2>
                <button onclick="toggleCart()" class="text-xl">&times;</button>
            </div>
            <div id="cart-items" class="flex-grow overflow-y-auto p-4 space-y-4"></div>
            <div class="p-6 border-t space-y-4">
                <div class="flex justify-between font-bold text-xl">
                    <span>Total:</span>
                    <span id="cart-total">S/ 0.00</span>
                </div>
                <button onclick="sendOrder()" class="w-full py-4 bg-green-600 text-white rounded-xl font-bold flex items-center justify-center gap-2">
                    <i class="fab fa-whatsapp text-xl"></i> Confirmar por WhatsApp
                </button>
            </div>
        </div>
    </div>

    <footer class="bg-white border-t mt-12 py-8 text-center px-4">
        <p class="font-bold text-gray-800 mb-4" id="footer-name"></p>
        <div class="flex justify-center gap-6 text-2xl text-gray-600 mb-6">
            <a id="link-wa" target="_blank" class="hover:text-green-500"><i class="fab fa-whatsapp"></i></a>
            <a id="link-ig" target="_blank" class="hover:text-pink-500"><i class="fab fa-instagram"></i></a>
            <a id="link-fb" target="_blank" class="hover:text-blue-600"><i class="fab fa-facebook"></i></a>
            <a id="link-tk" target="_blank" class="hover:text-black"><i class="fab fa-tiktok"></i></a>
        </div>
        <p class="text-xs text-gray-400">© 2024 - Catálogo Digital Rápido</p>
    </footer>

    <script>
        let allProducts = [];
        let filteredProducts = [];
        let cart = JSON.parse(localStorage.getItem(CONFIG.prefix + 'cart')) || [];
        let currentPage = 1;
        const perPage = 25;

        // PARSER RFC 4180 (Soporta multilínea y comillas)
        function parseCSV(text) {
            const result = [];
            let row = [''];
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                let c = text[i], next = text[i+1];
                if (inQuotes) {
                    if (c === '"' && next === '"') { row[row.length-1] += '"'; i++; }
                    else if (c === '"') { inQuotes = false; }
                    else { row[row.length-1] += c; }
                } else {
                    if (c === '"') { inQuotes = true; }
                    else if (c === ',') { row.push(''); }
                    else if (c === '\r' || c === '\n') {
                        if (row.length > 1 || row[0] !== '') result.push(row);
                        row = [''];
                        if (c === '\r' && next === '\n') i++;
                    } else { row[row.length-1] += c; }
                }
            }
            if (row.length > 1 || row[0] !== '') result.push(row);
            return result;
        }

        async function init() {
            // UI Init
            document.getElementById('brand-logo').innerText = CONFIG.businessName;
            document.getElementById('footer-name').innerText = CONFIG.businessName;
            document.getElementById('link-wa').href = `https://wa.me/${CONFIG.whatsapp}`;
            document.getElementById('link-ig').href = CONFIG.instagram;
            document.getElementById('link-fb').href = CONFIG.facebook;
            document.getElementById('link-tk').href = CONFIG.tiktok;
            updateCartUI();

            // Data Fetching
            const cacheKey = CONFIG.prefix + 'data';
            const cacheTimeKey = CONFIG.prefix + 'timestamp';
            const cachedData = localStorage.getItem(cacheKey);
            const cachedTime = localStorage.getItem(cacheTimeKey);

            if (cachedData && cachedTime && (Date.now() - cachedTime < CONFIG.cacheTime)) {
                allProducts = JSON.parse(cachedData);
                renderApp();
            } else {
                try {
                    const res = await fetch(CONFIG.sheetUrl);
                    const csvText = await res.text();
                    const rawRows = parseCSV(csvText);
                    const headers = rawRows[0];
                    
                    allProducts = rawRows.slice(1).map(row => ({
                        id: Math.random().toString(36).substr(2, 9),
                        nombre: row[0],
                        precio: parseFloat(row[1]) || 0,
                        precioRebajado: parseFloat(row[2]) || null,
                        categoria: row[3],
                        descripcion: row[4],
                        imagen: row[5] || 'https://via.placeholder.com/300?text=Sin+Imagen'
                    }));

                    localStorage.setItem(cacheKey, JSON.stringify(allProducts));
                    localStorage.setItem(cacheTimeKey, Date.now().toString());
                    renderApp();
                } catch (e) {
                    console.error("Error cargando datos", e);
                }
            }
        }

        function renderApp() {
            filteredProducts = [...allProducts];
            renderCategories();
            applyFilters();
        }

        function renderCategories() {
            const cats = [...new Set(allProducts.map(p => p.categoria))];
            const container = document.getElementById('category-bar');
            cats.forEach(cat => {
                if(!cat) return;
                const btn = document.createElement('button');
                btn.className = "category-pill px-4 py-1 rounded-full text-sm border bg-white";
                btn.innerText = cat;
                btn.onclick = (e) => {
                    document.querySelectorAll('.category-pill').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    filterCategory(cat);
                };
                container.appendChild(btn);
            });
        }

        function applyFilters() {
            const term = document.getElementById('search-input').value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            filteredProducts = allProducts.filter(p => {
                const text = `${p.nombre} ${p.descripcion}`.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                return text.includes(term);
            });

            currentPage = 1;
            renderGrid();
        }

        function filterCategory(cat) {
            if(cat === 'all') {
                filteredProducts = [...allProducts];
            } else {
                filteredProducts = allProducts.filter(p => p.categoria === cat);
            }
            applyFilters();
        }

        function renderGrid() {
            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            const pageData = filteredProducts.slice(start, end);
            const grid = document.getElementById('product-grid');
            
            grid.innerHTML = pageData.map(p => `
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 flex flex-col cursor-pointer" onclick="openModal('${p.id}')">
                    <div class="relative aspect-square bg-gray-100">
                        <img src="${p.imagen}" loading="lazy" class="w-full h-full object-cover">
                        ${p.precioRebajado ? `<span class="absolute top-2 left-2 bg-red-600 text-white text-xs px-2 py-1 rounded-md font-bold">OFERTA</span>` : ''}
                    </div>
                    <div class="p-3 flex flex-col flex-grow">
                        <h3 class="text-sm font-medium line-clamp-2 mb-1">${p.nombre}</h3>
                        <div class="mt-auto">
                            ${p.precioRebajado 
                                ? `<span class="text-red-600 font-bold">${CONFIG.currency}${p.precioRebajado.toFixed(2)}</span>
                                   <span class="text-xs text-gray-400 line-through ml-1">${CONFIG.currency}${p.precio.toFixed(2)}</span>`
                                : `<span class="font-bold">${CONFIG.currency}${p.precio.toFixed(2)}</span>`
                            }
                        </div>
                        <button onclick="event.stopPropagation(); addToCart('${p.id}')" class="mt-3 w-full py-2 bg-[var(--main-color)] text-white rounded-lg text-xs font-bold">Añadir</button>
                    </div>
                </div>
            `).join('');

            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredProducts.length / perPage);
            const container = document.getElementById('pagination');
            container.innerHTML = '';
            
            if(totalPages <= 1) return;

            for(let i=1; i<=totalPages; i++) {
                container.innerHTML += `<button onclick="goToPage(${i})" class="px-4 py-2 rounded ${currentPage === i ? 'bg-[var(--main-color)] text-white' : 'bg-white border'}">${i}</button>`;
            }
        }

        function goToPage(n) { currentPage = n; renderGrid(); window.scrollTo(0,0); }

        // BUSCADOR EN TIEMPO REAL
        document.getElementById('search-input').addEventListener('input', applyFilters);

        // MODAL LOGIC
        function openModal(id) {
            const p = allProducts.find(x => x.id === id);
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <img src="${p.imagen}" class="w-full rounded-xl mb-4">
                <span class="text-xs uppercase text-gray-500 font-bold">${p.categoria}</span>
                <h2 class="text-2xl font-bold mb-2">${p.nombre}</h2>
                <p class="text-gray-600 mb-6 text-sm whitespace-pre-line">${p.descripcion}</p>
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <p class="text-xs text-gray-400">Precio</p>
                        <p class="text-3xl font-bold text-[var(--main-color)]">${CONFIG.currency}${(p.precioRebajado || p.precio).toFixed(2)}</p>
                    </div>
                    <button onclick="addToCart('${p.id}'); closeModal()" class="px-8 py-3 bg-[var(--main-color)] text-white rounded-xl font-bold shadow-lg">Añadir al carrito</button>
                </div>
            `;
            document.getElementById('product-modal').classList.remove('hidden');
            document.body.classList.add('modal-active');
        }

        function closeModal() {
            document.getElementById('product-modal').classList.add('hidden');
            document.body.classList.remove('modal-active');
        }

        // CARRITO LOGIC
        function toggleCart() {
            document.getElementById('cart-sidebar').classList.toggle('translate-x-full');
        }

        function addToCart(id) {
            const p = allProducts.find(x => x.id === id);
            const item = cart.find(x => x.id === id);
            if(item) { item.qty++; } 
            else { cart.push({...p, qty: 1}); }
            saveCart();
            updateCartUI();
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            const count = document.getElementById('cart-count');
            const totalEl = document.getElementById('cart-total');
            
            let total = 0;
            let itemsCount = 0;

            container.innerHTML = cart.map(item => {
                const subtotal = (item.precioRebajado || item.precio) * item.qty;
                total += subtotal;
                itemsCount += item.qty;
                return `
                    <div class="flex gap-4 items-center border-b pb-4">
                        <img src="${item.imagen}" class="w-16 h-16 object-cover rounded-lg">
                        <div class="flex-grow">
                            <h4 class="text-sm font-bold line-clamp-1">${item.nombre}</h4>
                            <p class="text-xs text-gray-500">${CONFIG.currency}${(item.precioRebajado || item.precio).toFixed(2)}</p>
                            <div class="flex items-center gap-2 mt-2">
                                <button onclick="changeQty('${item.id}', -1)" class="w-6 h-6 border rounded">-</button>
                                <span class="text-sm">${item.qty}</span>
                                <button onclick="changeQty('${item.id}', 1)" class="w-6 h-6 border rounded">+</button>
                            </div>
                        </div>
                        <p class="text-sm font-bold">${CONFIG.currency}${subtotal.toFixed(2)}</p>
                    </div>
                `;
            }).join('');

            count.innerText = itemsCount;
            count.classList.toggle('hidden', itemsCount === 0);
            totalEl.innerText = `${CONFIG.currency}${total.toFixed(2)}`;
        }

        function changeQty(id, delta) {
            const item = cart.find(x => x.id === id);
            item.qty += delta;
            if(item.qty <= 0) cart = cart.filter(x => x.id !== id);
            saveCart();
            updateCartUI();
        }

        function saveCart() {
            localStorage.setItem(CONFIG.prefix + 'cart', JSON.stringify(cart));
        }

        function sendOrder() {
            if(cart.length === 0) return alert('El carrito está vacío');
            
            let msg = `*Pedido - ${CONFIG.businessName}*\n--------------------------\n`;
            let total = 0;
            
            cart.forEach(item => {
                const price = (item.precioRebajado || item.precio);
                const subtotal = price * item.qty;
                total += subtotal;
                msg += `• ${item.qty}x ${item.nombre} (${CONFIG.currency}${price.toFixed(2)}) = *${CONFIG.currency}${subtotal.toFixed(2)}*\n`;
            });
            
            msg += `--------------------------\n*TOTAL: ${CONFIG.currency}${total.toFixed(2)}*`;
            
            const url = `https://wa.me/${CONFIG.whatsapp}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        init();
    </script>
</body>
</html>
